---
title: "Case study: Evaluating the effectiveness of surrogates"
#date: "`r format(Sys.time(), '%d %B %Y')`"
#author: "Pierre Vernier"
output:
  html_document:
    keep_md: false
    code_folding: hide
    css: styles.css
params:
    eco: 89
---

<br>

# Introduction

In this vignette, we illustrate the basic steps for evaluating the effectiveness of four environmental surrogates for four test features (ConiferBirds, DeciduousBirds, MixedwoodBirds, and GrasslandBirds) that occur in the boreal region of Canada. Specifically, we focus on the data preparation and analysis steps that are at the core of the surrogates evaluation. The examples focus on one benchmark network located in one ecoregion in the boreal region. The sample benchmarks network that we use as an example has the highest representation value for the four surrogates among the candidate networks in the nets_rep.shp shapefile. We are interested in evaluating if the sample network is also representative of our four test features. All the required input data have already been generated and are located in the "data" folder. Please contact me (pierre.vernier@gmail.com) if you come across any problems trying to replicate this sample analysis.

<br>

# Data preparation

## Step 1 - Import libraries

We first need to import some libraries for reading and analysing raster and vector data, and three functions for calculating dissimilarity and representation metrics: *calcBC* for calculating the Bray-Curtis metric for categorical data, *calcKS* for calculating the Kolmogorov-Smirnov statistic for continuous data, and *calcRI* for calculating the representation index for continuous data. The functions are in the main folder but you will need to install the packages using the "install.packages" function i.e., install.packages("sf", "raster", "tmap", "tidyverse").

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(sf)
library(DT)
library(raster)
library(tmap)
library(tidyverse)
source("R/calcKS.R")
source("R/calcBC.R")
source("R/calcRI.R")
```

## Step 2 - Read datasets

We can now read the data into R. The study area consists of the ecoregion plus intersecting watersheds (FDAs). The ecoregion and FDA boundaries will be used as the reference areas in the analyses i.e., the region that the networks are compared to in terms of surrogates and test species. Networks are allowed to extend across ecoregion boundaries to enable hydrologic connectivity. The following datasets are available in the "data" folder:

  * fda.shp - FDA boundary shapefile (extent of study area)
  * eco.shp - Ecoregion boundary shapefile (extent of reference area within study area
  * pas.shp - Existing protected areas shapefile
  * nets_rep.shp - Candidate representative benchmarks networks shapefile
  * ConiferBirds.tif - Density raster of bird species associated conifer forests
  * DeciduousBirds.tif - Density raster of bird species associated with deciduous forests
  * MixedwoodBirds.tif - Density raster of bird species associated with mixedwood forests
  * GrasslandBirds.tif - Density raster of bird species associated with grasslands

```{r, echo=FALSE, message=FALSE, warning=FALSE}
eco = st_read(paste0("eco",params$eco,"/eco.shp"), quiet=T) %>% 
    mutate(legend="Ecoregion")
fda = st_read(paste0("eco",params$eco,"/fda.shp"), quiet=T) %>%
    st_union()
pas = st_read(paste0("eco",params$eco,"/pas.shp"), quiet=T) %>% mutate(legend="Protected areas")
nets = st_read(paste0("eco",params$eco,"/nets_rep.shp"), quiet=T) %>%
    st_transform(crs(fda)) %>% 
    mutate(one=1, distance = sqrt(ks_cmi^2 + ks_gpp^2 + ks_led^2 + bc_lcc^2)/2) %>%
    arrange(distance)
net = slice_head(nets) %>% 
    slice_head() %>%
    select(network) %>% 
    mutate(legend="Sample network")
cmi = raster(paste0("eco",params$eco,"/cmi.tif"))
gpp = raster(paste0("eco",params$eco,"/gpp.tif"))
led = raster(paste0("eco",params$eco,"/led.tif"))
lcc = raster(paste0("eco",params$eco,"/lcc.tif"))
r1 = raster(paste0("eco",params$eco,"/ConiferBirds.tif"))
r1_median = round(cellStats(r1, median),1)
r1_min = round(cellStats(r1, min),1)
r1_max = round(cellStats(r1, max),1)
r2 = raster(paste0("eco",params$eco,"/DeciduousBirds.tif"))
r2_median = round(cellStats(r2, median),1)
r2_min = round(cellStats(r2, min),1)
r2_max = round(cellStats(r2, max),1)
r3 = raster(paste0("eco",params$eco,"/MixedwoodBirds.tif"))
r3_median = round(cellStats(r3, median),1)
r3_min = round(cellStats(r3, min),1)
r3_max = round(cellStats(r3, max),1)
r4 = raster(paste0("eco",params$eco,"/GrasslandBirds.tif"))
r4_median = round(cellStats(r4, median),1)
r4_min = round(cellStats(r4, min),1)
r4_max = round(cellStats(r4, max),1)
```

## Step 3 - View study area

The following map shows the location of ecoregion (grey) in the boreal region along with the extent of the intersecting watersheds (black outline), existing protected areas (green), and the sample network (red) comprising of 3 ecological benchmarks.

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
osmtiles <- tmaptools::read_osm(fda, type="esri")
tm_shape(osmtiles) + tm_rgb() +
    tm_shape(eco) + tm_polygons(col="legend", title="", pal="#1D1D1D", alpha=0.5) + 
    #tm_shape(pas) + tm_polygons(col="legend", title="", pal="#377EB8", border.col="#377EB8", alpha=1) +
    tm_shape(pas) + tm_polygons(col="legend", title="", pal="darkgreen", border.col="darkgreen", alpha=0.75) +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#E41A1C", border.col="#E41A1C", alpha=0.5) + 
    tm_shape(fda) + tm_borders(lwd=1, col="black") +
    tm_legend(position = c("right", "top"), frame=FALSE) +
    tm_compass(position = c("left", "bottom")) +
    tm_scale_bar(position = c("right", "bottom"))
```

<br>

## Step 4 - Plot surrogates
***
The four plots show the distribution of climate moisture index (CMI), gross primary productivity (GPP), lake edge density (LED) and landcover (LCC) in the ecoregion and its intersecting watersheds. The sample benchmark network is also shown on each map.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=12}
net <- mutate(net, legend="Sample network")
tm1 <- tm_shape(cmi) + tm_raster(n=5, palette="RdYlBu", style="quantile", title = "CMI") +
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.5, border.alpha=0.5) +
    tm_layout(main.title="Climate Moisture Index", legend.position = c("right", "top"))
tm2 <- tm_shape(gpp) + tm_raster(n=5, palette="YlOrBr", style="quantile", title = "GPP") +
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.5, border.alpha=0.5) +
    tm_layout(main.title="Gross primary productivity", legend.position = c("right", "top"))
tm3 <- tm_shape(led) + tm_raster(palette="Blues", style="quantile", title = "LED") +
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.5, border.alpha=0.5) +
    tm_layout(main.title="Lake-edge density", legend.position = c("right", "top"))
#lcc_pal = c(rgb(0,61,0, max=255), rgb(148,156,112, max=255), rgb(20,140,61, max=255), rgb(92,117,43, max=255), rgb(179,138,51, max=255), rgb(224,207,138, max=255), rgb(156,117,84, max=255), rgb(186,212,143, max=255), rgb(107,163,138, max=255), rgb(168,171,173, max=255), rgb(77,112,163, max=255))
tm4 <- tm_shape(lcc) + tm_raster(style="pretty", title="LCC") + # pal=lcc_pal, style='cat'
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.5, border.alpha=0.5) +
    tm_layout(main.title="Landcover", legend.position = c("right", "top"))

print(tmap_arrange(tm1, tm2, tm3, tm4))
```

## Step 5 - Plot test features
***
The four plots show the distribution of density values for ConiferBirds, DeciduousBirds, MixedwoodBirds and GrasslandBirds in the ecoregion and its intersecting watersheds. The sample benchmark network is also shown on each map.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=12}
tm1 <- tm_shape(r1) + tm_raster(palette="YlGn", style="quantile", title = "Density") +
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.5, border.alpha=0.5) +
    tm_layout(main.title="ConiferBirds", title.position = c("left", "top"), legend.position = c("right", "top"), frame=T)
tm2 <- tm_shape(r2) + tm_raster(palette="YlGn", style="quantile", title = "Density") +
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.5, border.alpha=0.5) +
    tm_layout(main.title="DeciduousBirds", title.position = c("left", "top"), legend.position = c("right", "top"), frame=T)
tm3 <- tm_shape(r3) + tm_raster(palette="YlGn", style="quantile", title = "Density") +
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.5, border.alpha=0.5) +
    tm_layout(main.title="MixedwoodBirds", title.position = c("left", "top"), legend.position = c("right", "top"), frame=T)
tm4 <- tm_shape(r4) + tm_raster(palette="YlGn", style="quantile", title = "RSF") +
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.5, border.alpha=0.5) +
    tm_layout(main.title="GrasslandBirds", title.position = c("left", "top"), legend.position = c("right", "top"), frame=T)
print(tmap_arrange(tm1, tm2, tm3, tm4))
```

# Evaluating representativeness

 In the representativeness analysis, we want to evaluate the representativeness of the sample network by comparing the distribution of values of each surrogate and test feature within the network to its distribution within the ecoregion (reference area).

## Step 6 - Calculate dissimilarity
***
In step 6, we calculate representation for biophysical surrogates and test features using dissimilarity metrics. We use the KS statistic for continuous maps and the Bray-Curtis metric for categorical data (land cover). We then summarize the results in a table. No statistical analysis can be performed in this example since we only calculated representativeness for one network in one ecoregion. In the full analysis (see Paper) we evaluated 17 test features across 30 ecoregions (grouped into 4 BCRs), with each ecoregion containing upwards of several thousand networks.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ks1 = calcKS(stack(cmi,gpp,led), eco, net)
bc1 = calcBC(lcc, eco, net)
ks2 = calcKS(stack(r1,r2,r3,r4), eco, net)
x1 = c("CMI","GPP","LED","LCC","ConiferBirds","DeciduousBirds","MixedwoodBirds","GrasslandBirds")
x2 = c("Climate moisture index","Gross primary productivity","Lake-edge density","Landcover","Conifer Birds","Deciduous Birds","Mixedwood Birds","Grassland Birds")
x3 = c("Surrogate","Surrogate","Surrogate","Surrogate","Test feature","Test feature","Test feature","Test feature")
x4 = c(unlist(ks1[2:4]), unlist(ks1[2]), unlist(ks2[2:5]))
df = tibble(Code=x1,Description=x2,Map_type=x3,Dissimilarity=sprintf("%.2f",x4))
datatable(df, rownames=F, options=list(dom = 'tip', scrollX = TRUE, scrollY = TRUE, pageLength = 25,
    columnDefs = list(list(className = 'dt-center', targets = 2:3))), class="compact")
```

In this example, the network we selected can be considered to be representative of the four surrogates using a threshold of 0.2 on a scale of 0-1, with lower values indicating increasing similarity. Other thresholds can be used. The KS values for the four test features are also shown in the far right column in the table. As with the surrogates, we consider test features to be representative if they have a KS values less than or equal to 0.2. This example is based on a sample size of one. By repeating this for many networks, we can model the relationship between surrogates representativeness and test features representativeness to assess whether or not a relationship exists.

<br>

# Maximizing representation

In the representation analysis, we want to evaluate the representation of the sample network by calculating the proportion of values of each test feature within the network to its proportion with the ecoregion and intersecting watersheds (reference area).

## Step 7 - Calculate representation
***

In step 7, we calculate the representation index for test features using the ratio of the proportion of test features in a network to the proportion of the network in the planning region. The table below provides the results using the representation index for the same network and species.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
fda_dslv <- st_union(fda) # for RI, use the FDA boundary as reference area
ri1 = calcRI(stack(r1,r2,r3,r4), fda_dslv, net)
ri1v = unlist(ri1[2:5])
cat("Representation Index\n--------------------\n","ConiferBirds:", sprintf("%.2f",ri1v[1]), "\n","DeciduousBirds:", sprintf("%.2f",ri1v[2]), "\n","MixedwoodBrids:", sprintf("%.2f",ri1v[3]), "\n","GrasslandBirds:", sprintf("%.2f",ri1v[4]), "\n")
```

For the test features, the sample network is considered to be representative if the representation index has a value that is close to or greater than 1.

## Step 8 - Maximize representation
***

In the final step of this vignette, we calculated the representation index for all representative networks (based on the four environmental surrogates) that were created for the ecoregion and we then selected the top network for each test species among all networks and among representative networks (based on surrogates).

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
y = calcRI(stack(r1,r2,r3,r4), fda_dslv, nets)
#y2 = calcKS(stack(r1,r2,r3,r4), fda_dslv, nets)
#dm = left_join(left_join(left_join(ks1, ks2), bc1), ri1) %>%
#    mutate(distance = round(sqrt(cmi_ks^2 + gpp_ks^2 + led_ks^2 + lcc_bc^2)/2,3)) %>%
#    arrange(distance)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
df = tibble(Code = c("ConiferBirds","DeciduousBirds","MixedwoodBirds","GrasslandBirds"),
    Density = c(paste0(sprintf("%.2f",r1_median)," (",sprintf("%.2f",r1_min),"-",sprintf("%.2f",r1_max),")"),paste0(sprintf("%.2f",r2_median)," (",sprintf("%.2f",r2_min),"-",sprintf("%.2f",r2_max),")"),paste0(sprintf("%.2f",r3_median)," (",sprintf("%.2f",r3_min),"-",sprintf("%.2f",r3_max),")"),paste0(sprintf("%.2f",r4_median)," (",sprintf("%.2f",r4_min),"-",sprintf("%.2f",r4_max),")")),
    Top_surrogates_network_KS = sprintf("%.2f",unlist(ks2[2:5])),
    Top_surrogates_network_RI = sprintf("%.2f",unlist(ri1[2:5])),
    Top_overall_network_RI = sprintf("%.2f",c(max(y$ConiferBirds_ri), max(y$DeciduousBirds_ri), max(y$MixedwoodBirds_ri), max(y$GrasslandBirds_ri))))
datatable(df, rownames=F, options=list(dom = 'tip', scrollX = TRUE, scrollY = TRUE, pageLength = 25,
    columnDefs = list(list(className = 'dt-center', targets = 1:4))), class="compact")
```

The results indicate that, for each test species, the best network for that species came from the larger set of networks not just the networks that are representative for the four surrogates. We also note, that representative networks were also identified for the four species amongst the set of representative networks. Interestingly, the same network was most representative for both Caribou and Rusty Blackbird.

The map below shows the location of the top network (based on representation index) in red for ConiferBirds, DeciduousBirds, MixedwoodBirds and GrasslandBirds. The sample networks used in the previous steps is also shown in grey.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=12}
# Select first "top" networks in case of ties
#topKS_ConiferBirds = y2$networks[y2$ConiferBirds_ks==max(y2$ConiferBirds_ks)][1]
#netKS_ConiferBirds = nets %>% filter(network==topKS_ConiferBirds) %>% mutate(legend="Top KS network")
#topKS_DeciduousBirds = y2$networks[y2$DeciduousBirds_ks==max(y2$DeciduousBirds_ks)][1]
#netKS_DeciduousBirds = nets %>% filter(network==topKS_DeciduousBirds) %>% mutate(legend="Top KS network")
#topKS_MixedwoodBirds = y2$networks[y2$MixedwoodBirds_ks==max(y2$MixedwoodBirds_ks)][1]
#netKS_MixedwoodBirds = nets %>% filter(network==topKS_MixedwoodBirds) %>% mutate(legend="Top KS network")
#topKS_GrasslandBirds = y2$networks[y2$GrasslandBirds_ks==max(y2$GrasslandBirds_ks)][1]
#netKS_GrasslandBirds = nets %>% filter(network==topKS_GrasslandBirds) %>% mutate(legend="Top KS network")

top_ConiferBirds = y$networks[y$ConiferBirds_ri==max(y$ConiferBirds_ri)][1]
net_ConiferBirds = nets %>% filter(network==top_ConiferBirds) %>% mutate(legend="Top RI network")
top_DeciduousBirds = y$networks[y$DeciduousBirds_ri==max(y$DeciduousBirds_ri)][1]
net_DeciduousBirds = nets %>% filter(network==top_DeciduousBirds) %>% mutate(legend="Top RI network")
top_MixedwoodBirds = y$networks[y$MixedwoodBirds_ri==max(y$MixedwoodBirds_ri)][1]
net_MixedwoodBirds = nets %>% filter(network==top_MixedwoodBirds) %>% mutate(legend="Top RI network")
top_GrasslandBirds = y$networks[y$GrasslandBirds_ri==max(y$GrasslandBirds_ri)][1]
net_GrasslandBirds = nets %>% filter(network==top_GrasslandBirds) %>% mutate(legend="Top RI network")

tm1 <- tm_shape(r1) + tm_raster(palette="YlGn", style="quantile", title = "Density") +
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.65, border.alpha=0.65) +
    #tm_shape(netKS_ConiferBirds) + tm_polygons(col="legend", title="", pal="blue", border.col="blue", alpha=0.65, border.alpha=0.65) +
    tm_shape(net_ConiferBirds) + tm_polygons(col="legend", title="", pal="#E41A1C", border.col="#E41A1C", alpha=0.65, border.alpha=0.65) +
    tm_layout(main.title="ConiferBirds", title.position = c("left", "top"), legend.position = c("right", "top"), frame=T)
tm2 <- tm_shape(r2) + tm_raster(palette="YlGn", style="quantile", title = "Density") +
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.65, border.alpha=0.65) +
    #tm_shape(netKS_DeciduousBirds) + tm_polygons(col="legend", title="", pal="blue", border.col="blue", alpha=0.65, border.alpha=0.65) +
    tm_shape(net_DeciduousBirds) + tm_polygons(col="legend", title="", pal="#E41A1C", border.col="#E41A1C", alpha=0.65, border.alpha=0.65) +
    tm_layout(main.title="DeciduousBirds", title.position = c("left", "top"), legend.position = c("right", "top"), frame=T)
tm3 <- tm_shape(r3) + tm_raster(palette="YlGn", style="quantile", title = "Density") +
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.65, border.alpha=0.65) +
    #tm_shape(netKS_MixedwoodBirds) + tm_polygons(col="legend", title="", pal="blue", border.col="blue", alpha=0.65, border.alpha=0.65) +
    tm_shape(net_MixedwoodBirds) + tm_polygons(col="legend", title="", pal="#E41A1C", border.col="#E41A1C", alpha=0.65, border.alpha=0.65) +
    tm_layout(main.title="MixedwoodBirds", title.position = c("left", "top"), legend.position = c("right", "top"), frame=T)
tm4 <- tm_shape(r4) + tm_raster(palette="YlGn", style="quantile", title = "RSF") +
    tm_shape(fda) + tm_borders(lwd=1, col="blue") +
    tm_shape(eco) + tm_borders(lwd=2, col="black") +
    tm_shape(net) + tm_polygons(col="legend", title="", pal="#000000", border.col="#000000", alpha=0.65, border.alpha=0.65) +
    #tm_shape(netKS_GrasslandBirds) + tm_polygons(col="legend", title="", pal="blue", border.col="blue", alpha=0.65, border.alpha=0.65) +
    tm_shape(net_GrasslandBirds) + tm_polygons(col="legend", title="", pal="#E41A1C", border.col="#E41A1C", alpha=0.65, border.alpha=0.65) +
    tm_layout(main.title="GrasslandBirds", title.position = c("left", "top"), legend.position = c("right", "top"), frame=T)
print(tmap_arrange(tm1, tm2, tm3, tm4))
```
